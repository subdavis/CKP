<!DOCTYPE html>
<html>

<body>
  <script nonce="main">
    /**
     * Adapted from  https://developers.google.com/drive/picker/guides/overview
     */
    let appId = "876467817034-rlas0hnb5jc9dt1qmp11l6g4724ktoqn.apps.googleusercontent.com";
    // Development Account
    // let appId = "714523444550-3pneinie5sspeg9eff8j5jutrebcmh5o.apps.googleusercontent.com";
    let driveScope = "https://www.googleapis.com/auth/drive.file";
    let accessToken = null;
    let pickerInited = false;
    let gisInited = false;
    let picker;
    let parent;
    let msgOrigin;

    // Use the API Loader script to load google.picker
    function onApiLoad() {
      gapi.load('picker', onPickerApiLoad);
    }

    function onPickerApiLoad() {
      pickerInited = true;
    }

    // Create and render a Google Picker object for selecting from Drive.
    function showPicker() {
      // TODO(developer): Replace with your API key
      const view = new google.picker.DocsView(google.picker.ViewId.DOCS).setQuery("*.kdbx")
      picker = new google.picker.PickerBuilder()
        .addView(view)
        .setOAuthToken(accessToken)
        .setOrigin(msgOrigin)
        .setCallback(pickerCallback)
        .setAppId(appId)
        .build();
      picker.setVisible(true);
    }

    function gisLoaded() {
      // TODO(developer): Replace with your client ID and required scopes.
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: appId,
        scope: driveScope,
        callback: async (response) => {
          console.info('Token Auth Callback', response);
          if (response.error !== undefined) {
            throw (response);
          }
          accessToken = response.access_token;
          showPicker();
        },
        error_callback: (error) => {
          console.error('error_callback', error);
          parent.postMessage({ m: 'pickerResult', url: null }, '*');
          throw error
        }
      });
      gisInited = true;
    }

    function launch() {
      if (accessToken === null) {
        // Prompt the user to select a Google Account and ask for consent to share their data
        // when establishing a new session.
        tokenClient.requestAccessToken({ prompt: 'consent' });
      } else {
        // Skip display of account chooser and consent dialog for an existing session.
        tokenClient.requestAccessToken({ prompt: '' });
      }
    }

    // A simple callback implementation.
    function pickerCallback(data) {
      let url = 'nothing';
      console.info('Picker Callback:', data);
      if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
        let doc = data[google.picker.Response.DOCUMENTS][0];
        url = doc[google.picker.Document.URL];
        parent.postMessage({ m: 'pickerResult', url: url }, '*');
      } else if (data[google.picker.Response.ACTION] == google.picker.Action.CANCEL) {
        parent.postMessage({ m: 'pickerResult', url: null }, '*');
      }
    }

    window.addEventListener("message", (event) => {
      console.log('Message:', event);
      const allowedPrefixes = ['chrome-extension://', 'moz-extension://'];
      const messageFromExtension = allowedPrefixes.some(p => event.origin.startsWith(p));
      if (pickerInited && messageFromExtension && event.data.m === 'showPicker') {
        parent = event.source;
        msgOrigin = event.origin;
        launch();
      }
    })

  </script>
  <!-- Load the Google API Loader script. -->
  <script async defer src="https://apis.google.com/js/api.js" onload="onApiLoad()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>

</html>